<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Video Chat</title>
    <style>
        #videoArea, #messageArea {
            width: 1050px;
            height: 300px;
            background: gray;
            margin-top: 30px;
            margin-left: 130px;
        }

        #selfArea, #remoteArea {
            width: 500px;
            height: 260px;
            margin-top: 5px;
            margin-left: 10px;
            background: burlywood;
        }

        #remoteArea {
            position: absolute;
            width: 500px;
            height: 260px;
            background: burlywood;
            margin-left: 530px;
            margin-top: -260px;
        }

        p {
            margin-left: 0px;
            margin-top: 0px
        }

        #messages {
            position: absolute;
            width: 1000px;
            height: 250px;
            margin-top: 5px;
            margin-left: 5px;
            background: aliceblue;
        }

        #message{
            position: absolute;
            width: 950px;
            height: 30px;
            margin-top: 263px;
            margin-left: 5px;
        }
        #send{
            position: absolute;
            width: 30px;
            height: 30px;
            margin-top: 263px;
            margin-left: 965px;
        }
        #startVideo{
            position: absolute;
            width: 30px;
            height: 30px;
            margin-top: 263px;
            margin-left: 1000px;
        }

        #self{
            height: 255px;
            width: 524px;
            position: absolute;
            margin-top: -30px;
            margin-left: 10px;
        }

        #remote{
            height: 255px;
            width: 524px;
            position: absolute;
            margin-top: -30px;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<div id="videoArea">
    video area
    <div id="selfArea">
        <p>self video</p>
        <video id="self" autoplay>

        </video>
    </div>
    <div id="remoteArea">
        <p>remote video</p>
        <video id="remote">

        </video>
    </div>
</div>
<div id="messageArea">
    <ul id="messages"></ul>
    <form action="">
        <input type="text" id="message"/>
        <input type="submit" value="send" id="send"/>
        <input type="button" value="video" id="startVideo"/>
    </form>
</div>

<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.js"></script>
<script>
    var isCaller = window.location.href.split('#')[1];

    var socket = new WebSocket("ws://127.0.0.1:3000");

    var iceServer = {
        "iceServers": [{
            "url": "stun:stun.l.google.com:19302"
        }]
    };

    var pc = new webkitRTCPeerConnection(iceServer);

    pc.onicecandidate = function(event){
      if(event.candidate !== null){
          socket.send(JSON.stringify({
              "type": "candidate",
              "data": {
                  "candidate": event.candidate
              }
          }));
      }
    };

    pc.onaddstream = function(event){
        $("#remote")[0].src = URL.createObjectURL(event.stream);
    }

    socket.onmessage = function(event){
        var json = JSON.parse(event.data);

        if(json.type==="textMessage"){
            $("#messages").append($("<li></li>").text(json.content.message));
        }else if(json.type ==="candidate"){
            pc.addIceCandidate(new RTCIceCandidate(json.data.candidate));
        }else{
            pc.setRemoteDescription(new RTCSessionDescription(json.data.sdp));

            if(json.type === "offer"){
                pc.createAnswer(sendAnswerFn, function(error){
                    if(error){
                        console.log("Fail callback: " + error);
                    }
                });
            }
        }
    };

    $("form").submit(function(){
        socket.send(JSON.stringify({"type": "textMessage", "content": {"message": $("#message").val()}}));
        $("#message").val('');
        return false;
    });

    var sendOfferFn = function (sdp){
        pc.setLocalDescription(sdp);

        socket.send(JSON.stringify({
            "type": "offer",
            "data": {
                "sdp": sdp
            }
        }));
    };

    var sendAnswerFn = function(sdp){
        pc.setLocalDescription(sdp);

        socket.send(JSON.stringify({
            "type" : "answer",
            "data" : {
                "sdp": sdp
            }
        }));
    };

    $("#startVideo").click(function(){
        navigator.webkitGetUserMedia({"video":true}, function(stream){
           $("#self")[0].src = URL.createObjectURL(stream);

            pc.addStream(stream);

            if(isCaller){
                pc.createOffer(sendOfferFn, function(error){
                   if(error){
                       console.log("Failure callback : " + error);
                   }
                });
            }
        }, function(error){
            if(error){
                console.log("get video error");
            }
        });
    });
</script>
</body>
</html>